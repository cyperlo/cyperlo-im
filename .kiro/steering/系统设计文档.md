# IM 系统开发设计文档

## 1. 项目背景与目标

### 1.1 背景

构建一个 **统一通信（IM）平台**，既可以满足内部即时通信需求，也可以作为 **统一登录与消息通道**，供后续第三方业务系统接入使用。

### 1.2 核心目标

* 提供稳定、高并发、可扩展的即时通信能力
* 支持统一账号体系（SSO）与第三方系统接入
* 支持 Web（React）优先，后续可扩展到移动端
* 后端采用 Go，具备微服务与云原生演进能力

### 1.3 非目标（当前阶段）

* 音视频通话（后续阶段）
* 强社交推荐、信息流

---

## 2. 总体架构设计

### 2.1 架构概览

```text
┌────────────┐        ┌────────────┐
│   React    │ <WS>   │   IM-GW    │
│  Web App   │ <HTTP> │  (Gateway) │
└────────────┘        └─────┬──────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼───────┐   ┌────────▼────────┐   ┌────────▼────────┐
│ Auth Service  │   │ Message Service  │   │ Presence Service │
│ (SSO/OAuth2)  │   │ (IM Core)        │   │ (在线状态)      │
└───────────────┘   └────────┬────────┘   └────────┬────────┘
                               │                     │
                       ┌───────▼────────┐   ┌────────▼────────┐
                       │ Storage Service │   │ Notify Service  │
                       │ (DB / MQ)       │   │ (推送)          │
                       └────────────────┘   └─────────────────┘
```

---

## 3. 技术选型

### 3.1 前端（React）

* React 18
* TypeScript
* 状态管理：Redux
* WebSocket：原生 WebSocket / socket.io-client
* UI：Ant Design / Arco Design
* 颜色主题: telegram

### 3.2 后端（Go）

* Go 1.22+
* Web 框架：Gin 
* WebSocket：gorilla/websocket
* ORM：GORM
* 数据库：MySQL + Redis
* 消息队列：Kafka / RabbitMQ（后期引入）

### 3.3 基础设施

* 鉴权：JWT + OAuth2
* ID 生成：Snowflake / UUID
* 部署：Docker + Kubernetes（可选）

---

## 4. 核心功能模块设计

## 4.1 账号与统一登录（Auth Service）

### 4.1.1 用户体系

* 用户（User）
* 应用（Client / App）—— 第三方系统

```text
User
- id
- username
- password_hash
- email
- status

Client
- client_id
- client_secret
- redirect_uri
- scopes
```

### 4.1.2 登录模式

* 内部用户：账号密码登录
* 第三方系统：OAuth2 授权登录

```text
Authorization Code Flow
Client → Auth → User Login → Code → Token
```

---

## 4.2 即时通信（Message Service）

### 4.2.1 消息模型

```text
Message
- id
- conversation_id
- sender_id
- sender_type (user/system/app)
- content_type (text/image/file)
- content
- created_at
- status
```

### 4.2.2 会话模型

```text
Conversation
- id
- type (single/group/system)
- members
- created_at
```

### 4.2.3 通信方式

* 客户端 ↔ 服务端：WebSocket
* 服务端内部：Channel / MQ

---

## 4.3 在线状态（Presence Service）

### 4.3.1 功能

* 用户在线 / 离线
* 多端登录支持
* 心跳检测

### 4.3.2 数据存储

* Redis

```text
key: presence:{user_id}
value: online | offline
```

---

## 4.4 第三方系统接入设计

### 4.4.1 接入方式

* OAuth2 登录 IM
* 使用 IM SDK / HTTP API 发送消息

### 4.4.2 API 示例

```http
POST /api/v1/messages
Authorization: Bearer {token}

{
  "to": "user_id",
  "content": "业务系统通知"
}
```

---

## 5. 前端设计（React）

### 5.1 页面结构

* 登录页
* 会话列表
* 聊天窗口
* 用户设置

### 5.2 WebSocket 管理

```ts
const ws = new WebSocket("wss://im.example.com/ws");

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data)
  // dispatch message
}
```

---

## 6. 安全设计

* HTTPS + WSS
* JWT 过期与刷新
* WebSocket 鉴权（Token 握手）
* 消息权限校验

---

## 7. 可扩展性设计

* 消息服务无状态化
* WebSocket Gateway 水平扩展
* MQ 解耦消息投递
* 插件化第三方应用

---

## 8. 开发阶段规划

### Phase 1（MVP）

* 单聊
* WebSocket
* 基础登录

### Phase 2

* 群聊
* 消息持久化
* 第三方系统推送消息

### Phase 3

* 多端同步
* 离线消息
* 管理后台

---

## 9. 后续可演进方向

* 移动端（Flutter / Android）
* 消息搜索（ES）
* 语音 / 视频（WebRTC）

---

## 10. 总结

该 IM 系统以 **统一通信 + 统一登录** 为核心，采用 Go + React 技术栈，具备良好的扩展性，能够作为企业级基础通信平台与第三方系统消息中枢。
